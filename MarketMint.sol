//*~~~> SPDX-License-Identifier: MIT OR Apache-2.0
/*~~~>
    Thank you Phunks, your inspiration and phriendship meant the world to me and helped me through hard times.
      Never stop phighting, never surrender, always stand up for what is right and make the best of all situations towards all people.
      Phunks are phreedom phighters!
        "When the power of love overcomes the love of power the world will know peace." - Jimi Hendrix <3

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################%%%%%@@@@@((((((((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################%%%%%@@@@@((((((((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@########################################%%%%%@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@########################################%%%%%@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###############@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@###############@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@#PHUNKYJON///////////////#PHUNKYJON//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@#PHUNKYJON///////////////#PHUNKYJON//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////@EYES////////////////////@EYES///////////////@@@@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////@EYES////////////////////@EYES///////////////EAR@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////////////////////////////////////////////EAR@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////////////////////////////////////////////EAR@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@@@@@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@/////////////////////////////////////////////@@@@@@@@@@((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////NOSE@NOSE@////////////////////#####@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((SMOKE((((((((((@@@@@//////////NOSE@NOSE@////////////////////#####@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@#####//////////////////////////////##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((@@@@@#####//////////////////////////////##########@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@###################################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@###################################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((EMBER(((((,,,,,,,,,,,,,,,,,,,,,,,,,@@@@@MOUTH&&&&&####################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((EMBER(((((,,,,,,,,,,,,,,,,,,,,,,,,,@@@@@MOUTH&&&&&####################@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@##############################/////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((@SPLIFF@SPLIFF@SPLIFF@SPLIFF@@##############################/////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%(((((((((((((((((((((((((((((((((((@@@@@##############################//////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((@@@@@@@@@@@@@@@@@@@@@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%((((((((((((((((((((((((((((((((((((((((((((((((((((((((((((@@@@@///////////////@@@@@(((((((((((((((((((((((((%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@///////////////@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@///////////////@@@@@%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

 <~~~*/
pragma solidity ^0.8.3;

import "@openzeppelin/contracts/utils/Counters.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/utils/math/SafeMath.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

/*~~~>
Interface declarations for upgradable contracts
<~~~*/
interface MarketNFT {
  function safeMint(address to, string memory uri) external;
}
interface NftFactory {
  function newNftContract(address controller, address minter, string memory name, string memory symbol) external;
}
interface Nft1155Factory {
  function new1155Contract(address controller, address minter, string memory tokenURI) external;
}
interface PhamNFT {
  function balanceOf(address owner) external returns(uint);
}
interface IERC20 {
  function balanceOf(address account) external view returns (uint256);
  function allowance(address owner, address spender) external view returns (uint256);
  function transfer(address recipient, uint256 amount) external returns (bool);
  function approve(address spender, uint256 amount) external returns (bool);
  function transferFrom(address sender, address recipient, uint256 amount) external returns (bool);
  event Transfer(address indexed from, address indexed to, uint256 value);
  event Approval(address indexed owner, address indexed spender, uint256 value);
}
interface RoleProvider {
  function hasTheRole(bytes32 role, address _address) external returns(bool);
  function fetchAddress(bytes32 _var) external returns(address);
}
interface RewardsController {
  function createUser(address userAddress) external;
  function depositEthToDAO() payable external;
  function depositDAOERC20Rewards(uint amount, address tokenAddress) external;
}
contract Mint is ReentrancyGuard, Pausable {
  using SafeMath for uint;
  using Counters for Counters.Counter;
  /*~~~>
    State variables
  <~~~*/
  Counters.Counter private _nftsCreated;
  Counters.Counter private _contractsCreated;
  Counters.Counter private _1155ContractsCreated;
  Counters.Counter private _redemptionERC20;

  uint64 public deployAmount;
  address public roleAdd;

  bytes32 public constant NFTADD = keccak256("NFT");
  address nftAddress = RoleProvider(roleAdd).fetchAddress(NFTADD);

  bytes32 public constant REWARDS = keccak256("REWARDS");
  address rewardsAddress = RoleProvider(roleAdd).fetchAddress(REWARDS);

  bytes32 public constant ERC721FACTORY = keccak256("ERC721FACTORY");
  address nftFactory = RoleProvider(roleAdd).fetchAddress(ERC721FACTORY);

  bytes32 public constant ERC1155FACTORY = keccak256("ERC1155FACTORY");
  address nft1155Factory = RoleProvider(roleAdd).fetchAddress(ERC1155FACTORY);


  //*~~~> Marketplace NFT that can be used to claim rewards and act as a DAO
  struct NFT {
    uint itemId;
    address creator;
  }
  //*~~~> New ERC721 Contracts
  struct NFTContract {
    string name;
    string symbol;
    uint ContractId;
    address controller;
    address minter;
    address creator;
  }
  //*~~~> New ERC1155 Contracts
  struct NFT1155Contract {
    string tokenURI;
    uint ContractId;
    address controller;
    address minter;
    address creator;
  }
  //*~~~> Tokens redeemed to create Marketplace NFTs
  struct RedemptionToken {
    uint redeemAmount;
    address contractAddress;
  }

  //*~~~> Roles for designated accessibility
  bytes32 public constant PROXY_ROLE = keccak256("PROXY_ROLE"); 
  bytes32 public constant DEV_ROLE = keccak256("DEV_ROLE");
  modifier hasAdmin(){
    require(RoleProvider(roleAdd).hasTheRole(PROXY_ROLE, msg.sender), "DOES NOT HAVE ADMIN ROLE");
    _;
  }
  modifier hasDevAdmin(){
    require(RoleProvider(roleAdd).hasTheRole(DEV_ROLE, msg.sender), "DOES NOT HAVE DEV ROLE");
    _;
  }

  constructor(address _role) {
    roleAdd =_role;
    deployAmount = (1e16);
  }

  //*~~~> Memory mappings
  mapping (uint256 => NFT) private _idToNft;
  mapping (uint256 => NFTContract) private _idToNftContract;
  mapping (uint256 => NFT1155Contract) private _idTo1155Contract;
  mapping (uint256 => RedemptionToken) private _idToRedemption;
  mapping (address => uint) private _indexToRedemptionToken;

  // Event declaration
  event nftCreated(uint nftId, address creator);
  event Received(address, uint);
  /*~~~>
    Restricted access functions for mutable state variables  
  <~~~*/
  function setDeployAmnt(uint64 _deployAmount) public hasAdmin returns(bool){
    deployAmount = _deployAmount;
    return true;
  }
  function setRoleAdd(address _role) public hasAdmin returns(bool){
    roleAdd = _role;
    return true;
  }

  /// @notice
  /*~~~>
    Function for setting the redemption token details
  <~~~*/
  /// @dev
  /*~~~>
    uint64 _redeemAmount: Amount needed to redeem a NFT; 
    address _contract: address of the redemption token;
  <~~~*/
  function setRedemptionToken(uint64 _redeemAmount, address _contract) public hasAdmin returns(bool){
    uint index = _indexToRedemptionToken[_contract];
    RedemptionToken memory red = _idToRedemption[index];
    red = RedemptionToken(_redeemAmount, _contract);
    return true;
  }
  
  /// @notice
  /*~~~> Function for setting new redemption tokens <~~~*/
  /// @dev
  /*~~~> 
    uint amount: amount needed to redeem for creating new NFTs;
    address _toke: address for the token;
  <~~~*/
  /// @return Bool
  function setNewRedemption(uint amount, address _toke) public hasAdmin returns(bool){
    _redemptionERC20.increment();
    uint id = _redemptionERC20.current();
    _idToRedemption[id] = RedemptionToken(amount, _toke);
    return true;
  }

  /// @notice
  /*~~~>
  Public interaction function for creating new NFTs by exchanging Tokens
  <~~~*/
  /// @dev
  /*~~~>
    uint id: index to the redemption token struct;
    uint amount: amount needed to redeem;
    address to: address to mint the NFT to
    string memory uri: uri for the NFT
  <~~~*/
  /// @return Bool
  function redeemForNft(uint id, uint amount, address to, string memory uri) public whenNotPaused returns(bool){
    RedemptionToken memory token = _idToRedemption[id];
    require(amount >= token.redeemAmount);

    IERC20 tokenContract = IERC20(token.contractAddress);
    uint256 allowance = tokenContract.allowance(msg.sender, address(this));
    require(allowance >= amount, "Check the token allowance");
    tokenContract.transferFrom(msg.sender, (address(this)), amount);
    
    MarketNFT(nftAddress).safeMint(to, uri);
    _nftsCreated.increment();
    uint256 nftId = _nftsCreated.current();
    _idToNft[nftId] = NFT(nftId, msg.sender);
    
    RewardsController(rewardsAddress).depositDAOERC20Rewards(amount, token.contractAddress);
    _idToRedemption[id] = RedemptionToken(token.redeemAmount, token.contractAddress);

    RewardsController(rewardsAddress).createUser(msg.sender);

    emit nftCreated(nftId, msg.sender);
    return true;
  }

  /// @notice
  /*~~~>
  Public interaction function for creating new ERC721 contracts
  <~~~*/
  /// @dev
  /*~~~>
    address controller: address of the Controller role;
    address minter: address of the Minter role;
    string calldata name: name of the Contract;
    string calldata symbol: symbol of the Contract;
  <~~~*/
  /// @return Bool
  function newNftContract(address controller, address minter, string calldata name, string calldata symbol) public payable whenNotPaused returns(bool) {
    require(msg.value >= deployAmount);
    NftFactory(nftFactory).newNftContract(controller, minter, name, symbol);
    RewardsController(rewardsAddress).depositEthToDAO{value: msg.value}();
    _contractsCreated.increment();
    uint256 contId = _contractsCreated.current();
    _idToNftContract[contId] = NFTContract(
      name,
      symbol,
      contId,
      controller,
      minter,
      msg.sender
    );
    return true;
  }


  /// @notice
  /*~~~>
  Public interaction function for creating new ERC1155 contracts
  <~~~*/
  /// @dev
  /*~~~>
    address controller: address of the Controller role;
    address minter: address of the Minter role;
    string calldata tokenURI: uri for the Contract;
  <~~~*/
  /// @return Bool
  function new1155Contract(address controller, address minter, string calldata tokenURI) public payable whenNotPaused returns(bool) {
    require(msg.value >= deployAmount);
    Nft1155Factory(nftFactory).new1155Contract(controller, minter, tokenURI);
    RewardsController(rewardsAddress).depositEthToDAO{value: msg.value}();
    _1155ContractsCreated.increment();
    uint256 contId = _1155ContractsCreated.current();
    _idTo1155Contract[contId] = NFT1155Contract(
      tokenURI,
      contId,
      controller,
      minter,
      msg.sender
    );
    return true;
  }


  /// @notice
  /*~~~>
  Functions for retrieving memory items
  <~~~*/
  function fetchNFTsCreated() public view returns (NFT[] memory) {
    uint itemCount = _nftsCreated.current();
    NFT[] memory nfts = new NFT[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      NFT storage currentItem = _idToNft[i + 1];
      nfts[currentIndex] = currentItem;
      currentIndex++;
    }
    return nfts;
  }

  function fetchNFTsCreatedByAddress(address creator) public view returns (NFT[] memory) {
    uint itemCount = _nftsCreated.current();
    NFT[] memory nfts = new NFT[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      if (_idToNft[i + 1].creator == creator) {
        NFT storage currentItem = _idToNft[i + 1];
         nfts[currentIndex] = currentItem;
         currentIndex++;
      }
    }
    return nfts;
  }
  
  function fetchNFTContractsCreated() public view returns (NFTContract[] memory) {
    uint itemCount = _contractsCreated.current();
    NFTContract[] memory contracts = new NFTContract[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      NFTContract storage currentItem = _idToNftContract[i + 1];
      contracts[currentIndex] = currentItem;
      currentIndex += 1;
    }
    return contracts;
  }

  function fetch1155NFTContractsCreated() public view returns (NFT1155Contract[] memory) {
    uint itemCount = _1155ContractsCreated.current();
    NFT1155Contract[] memory contracts = new NFT1155Contract[](itemCount);
    uint currentIndex;
    for (uint i; i < itemCount; i++) {
      NFT1155Contract storage currentItem = _idTo1155Contract[i + 1];
      contracts[currentIndex] = currentItem;
      currentIndex += 1;
    }
    return contracts;
  }

  ///@notice DEV operations for emergency functions
  function pause() public hasDevAdmin {
      _pause();
  }
  function unpause() public hasDevAdmin {
      _unpause();
  }

  ///@notice
  /*~~~> External ETH transfer forwarded to role provider contract <~~~*/
  event FundsForwarded(uint value, address _from, address _to);
  receive() external payable {
    payable(roleAdd).transfer(msg.value);
      emit FundsForwarded(msg.value, msg.sender, roleAdd);
  }
}
